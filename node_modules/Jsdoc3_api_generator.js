/*jslint indent: 4, maxerr: 50, white: true, node: true, stupid: true */

/**
 * @file This file contains code to regenerate the api documentation for
 *  JSDoc 3 and merge it into the documentation website.
 * @author <a href="matthewkastor@gmail.com">Matthew Kastor</a>
 * @version 20121028
 * @requires events
 * @requires util
 */

'use strict';

var util, events;

util   = require('util');
events = require('events');


/**
 * Calls jsdoc --describeTags htmlFiles -d <jsdoc3.github.com> to
 *  update the tags definition files. Generates API documentation from 
 *  JSDoc 3. Then calls jake to rebuild the docs.
 * @author <a href="matthewkastor@gmail.com">Matthew Kastor</a>
 * @class
 * @version 20121028
 * @requires events
 * @requires util
 * @requires path
 * @requires cmd
 * @requires jsdoc3_utilities
 */
function Jsdoc3_api_generator() {
    var path,
        cmd,
        jsdoc3_utilities;
    
    path             = require('path');
    cmd              = require('cmd');
    jsdoc3_utilities = require('jsdoc3_utilities');
    
    events.EventEmitter.call(this);

    this.on('error',
        function(err) {
            console.log(err);
            process.exit(1);
        }
    );
    
    this.generateDocs = function generateDocs() {
        
        var syncReg, asyncReg, places, recurse;
        
        syncReg = new cmd.commandRegister.Synchronous('sync');
        asyncReg = new cmd.commandRegister.Asynchronous('async');
        
        syncReg.on('command queue processed', function (name) {
            console.log('register ' + name + ' has finished');
        });
        
        asyncReg.on('command queue processed', function (name) {
            console.log('register ' + name + ' has finished');
            syncReg.process();
        });
        
        syncReg.queue = [
            jsdoc3_utilities.rebuildDescribeTags,
            jsdoc3_utilities.runJake
        ];
        
        places = [
            'rhino_modules',
            'templates',
            'plugins',
            'node_modules',
            'jsdoc.js'
        ];
        
        places.forEach(function(place) {
            if(place === 'jsdoc.js') {
                recurse = false;
            } else {
                recurse = true;
            }
            asyncReg.queue.unshift(
                jsdoc3_utilities.createRunJsdocCommand(recurse, place)
            );
        });
        
        asyncReg.process();
        
    };
    
}
util.inherits(Jsdoc3_api_generator, events.EventEmitter);

// var generator = new Jsdoc3_api_generator();
// generator.generateDocs();

exports.Jsdoc3_api_generator = Jsdoc3_api_generator;